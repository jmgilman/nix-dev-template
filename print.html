<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Nixago</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="quick_start.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item expanded "><a href="engines/index.html"><strong aria-hidden="true">3.</strong> Engines</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="engines/cue.html"><strong aria-hidden="true">3.1.</strong> CUE</a></li><li class="chapter-item expanded "><a href="engines/nix.html"><strong aria-hidden="true">3.2.</strong> Nix</a></li></ol></li><li class="chapter-item expanded "><a href="contributing/index.html"><strong aria-hidden="true">4.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributing/design.html"><strong aria-hidden="true">4.1.</strong> Design</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nixago</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Nixago is a <a href="https://nixos.wiki/wiki/Flakes">flake</a> library for generating configuration files. It's
primarily geared towards reducing the clutter at the root of your repository
added by various development tools (i.e., formatters, linters, etc.). However,
Nixago is flexible enough to generate configuration files for most scenarios.</p>
<p>Nixago is designed to be used in tandem with a <a href="https://nixos.org/manual/nix/stable/command-ref/nix-shell.html">nix shell</a> to dynamically
create and manage configuration files in your existing development environments.
Define the configurations in the <code>flake.nix</code> file at the root of your
repository, and Nixago will automatically generate shell hooks for managing the
files.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<p>Add Nixago as an input to your <code>flake.nix</code>:</p>
<pre><code class="language-nix">{
  inputs = {
    # ...
    nixpkgs.url = &quot;github:nixos/nixpkgs/nixpkgs-unstable&quot;;
    nixago.url = &quot;github:nix-community/nixago&quot;;
    nixago.inputs.nixpkgs.follows = &quot;nixpkgs&quot;;
    # ...
  };
}
</code></pre>
<h2 id="generate-a-configuration"><a class="header" href="#generate-a-configuration">Generate a Configuration</a></h2>
<p>Nixago offers <a href="./engines/index.html">various engines</a> which can be used for
transforming input data into an output file. Nixago will default to the
<a href="./engines/nix.html">nix engine</a> that utilizes <code>pkgs.formats</code> from <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/pkgs-lib/formats.nix">nixpkgs</a>.</p>
<pre><code class="language-nix">let
  data = {
    &quot;field1&quot; = &quot;value1&quot;;
    &quot;field2&quot; = true;
  };
in
nixago.lib.make {
  inherit data;
  output = &quot;config.json&quot;;
  format = &quot;json&quot;;
  engine = nixago.engines.nix { }; # Optional as this is the default value
}
</code></pre>
<p>The result of this invocation will be an attribute set with two attributes:</p>
<ul>
<li><code>configFile</code>: A derivation for building the configuration file.</li>
<li><code>shellHook</code>: A shell hook for managing the file.</li>
</ul>
<p>Building the derivation produces a file with the following output:</p>
<pre><code class="language-json">{
  &quot;field1&quot;: &quot;value1&quot;,
  &quot;field2&quot;: true
}
</code></pre>
<p>The <code>make</code> function takes an attribute set that supports the options defined in
the <a href="https://github.com/nix-community/nixago/blob/master/modules/request.nix">request module</a>. Please refer to the module definition for all of the
available options.</p>
<h2 id="using-the-shell-hook"><a class="header" href="#using-the-shell-hook">Using the Shell Hook</a></h2>
<p>The generated shell hook will link the generated configuration file to one of
two places:</p>
<ul>
<li>If <code>$PRJ_ROOT</code> is defined, the file will be linked to <code>$PRJ_ROOT/{output}</code>
where <code>output</code> is the relative path defined in the call to <code>make</code>.</li>
<li>If <code>$PRJ_ROOT</code> is not defined, the file will be linked to <code>./{output}</code>, where
the relative path is determined by where the Nix CLI was invoked.</li>
</ul>
<p>For example, if <code>$PRJ_ROOT</code> is set to <code>/home/user/code/myprj</code> and the output is
specified as <code>configs/config.json</code> then the file will be linked to
<code>/home/user/code/myprj/configs/config.json</code>.</p>
<p>The shell hook is designed to be integrated into a development shell:</p>
<pre><code class="language-nix">{
  # ...
  devShells = {
    default = pkgs.mkShell {
      shellHook = (nixago.lib.make config).shellHook;
    };
  };
 # ...
}
</code></pre>
<p>This will ensure the file is generated and linked when you enter the shell. The
behavior of the hook can be modified via the <a href="https://github.com/nix-community/nixago/blob/master/modules/request.nix#L8">available options</a>.</p>
<h2 id="extending-nixago"><a class="header" href="#extending-nixago">Extending Nixago</a></h2>
<p>An <a href="https://github.com/nix-community/nixago-extensions">additional repository</a> is available that provides extensions for Nixago.
These simplify the process of generating configuration files for common
development tools.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="engines"><a class="header" href="#engines">Engines</a></h1>
<p>Nixago provides various engines which can be used for changing how the
configuration file is being generated. If you would like to suggest a new
engine, please <a href="https://github.com/nix-community/nixago/issues/new">open an issue</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cue"><a class="header" href="#cue">CUE</a></h1>
<p>This engine provides an interface for generating configuration files using the
<a href="https://cuelang.org/">CUE language</a> and its associated <a href="https://cuetorials.com/overview/cli-commands/">CLI tool</a>. It allows combining the
user-defined input with one or more CUE files and generating a file in the
designated output format.</p>
<p>For more information on the design of CUE, <a href="https://cuelang.org/docs/concepts/logic/">see this doc</a>. A good place to
start learning the fundamentals is the <a href="https://cuetorials.com/">Cuetorials website</a>.</p>
<h2 id="concepts"><a class="header" href="#concepts">Concepts</a></h2>
<h3 id="merging"><a class="header" href="#merging">Merging</a></h3>
<p>When using CUE, you will typically define one or more CUE files that will be
merged into the desired output. For example, if we had the below CUE file:</p>
<pre><code class="language-cue">name: string
name: &quot;John Doe&quot;
</code></pre>
<p>We could then export it and get the following result:</p>
<pre><code class="language-bash">$ cue export file.cue
{
    &quot;name&quot;: &quot;John Doe&quot;
}
</code></pre>
<p>When CUE is presented with multiple files, they are all merged into one singular
output:</p>
<pre><code class="language-cue">name: string
</code></pre>
<pre><code class="language-cue">name: &quot;John Doe&quot;
</code></pre>
<pre><code class="language-bash">$ cue export file1.cue file2.cue
{
    &quot;name&quot;: &quot;John Doe&quot;
}
</code></pre>
<h3 id="combining-with-json"><a class="header" href="#combining-with-json">Combining with JSON</a></h3>
<p>CUE is a superset of JSON, so it's possible to merge JSON and CUE files. Using
our previous example, this time with JSON:</p>
<pre><code class="language-cue">name: string
</code></pre>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;John Doe&quot;
}
</code></pre>
<pre><code class="language-bash">cue export file1.cue file2.json
{
    &quot;name&quot;: &quot;John Doe&quot;
}
</code></pre>
<p>We get the same result because our JSON file and the previously defined CUE file
are functionally equivalent.</p>
<h3 id="constraints"><a class="header" href="#constraints">Constraints</a></h3>
<p>Performing input validation is a natural benefit when using the CUE language. We
used a <a href="https://cuelang.org/docs/tutorials/tour/intro/constraints/">constraint</a> earlier when we constrained the <code>name</code> field to a string.
Continuing with our previous examples, if we modified the JSON structure to be
the following:</p>
<pre><code class="language-json">{
  &quot;name&quot;: 42
}
</code></pre>
<p>Then if we attempted to export both files, we would receive an error:</p>
<blockquote>
<p>name: conflicting values 42 and string (mismatched types int and string)</p>
</blockquote>
<p>CUE is informing us that we constrained <code>name</code> to a <code>string</code>, and yet we passed
in an int (42) with our JSON data structure. This is a type mismatch and results
in an error.</p>
<h3 id="exporting-modified-structures"><a class="header" href="#exporting-modified-structures">Exporting Modified Structures</a></h3>
<p>A common use case is transforming an incoming structure into a modified outgoing
structure. Take the following input structure:</p>
<pre><code class="language-json">{
  &quot;first_name&quot;: &quot;john&quot;,
  &quot;last_name&quot;: &quot;doe&quot;,
  &quot;address&quot;: &quot;123 Lane&quot;,
  &quot;city&quot;: &quot;Springfield&quot;,
  &quot;state&quot;: &quot;OR&quot;
}
</code></pre>
<p>We only want to export the name and a combined address:</p>
<pre><code class="language-cue">import &quot;strings&quot;

first_name: string
last_name: string
address: string
city: string
state: string

result: {
    name: strings.ToTitle(strings.Join([first_name, last_name], &quot; &quot;))
    full_address: &quot;\(address)\n\(city), \(state)&quot;
}
</code></pre>
<p>We can then ask CUE to <em>only</em> render our <code>result</code> expression:</p>
<pre><code class="language-bash">$ cue export -e result file1.cue file2.json
{
    &quot;name&quot;: &quot;John Doe&quot;,
    &quot;full_address&quot;: &quot;123 Lane\nSpringfield, OR&quot;
}
</code></pre>
<p>This allows ingesting one data structure and exporting another. As shown in the
example, we can perform many permutations on the incoming data using CUE's
<a href="https://cuetorials.com/overview/standard-library/">standard library</a> and <a href="https://cuetorials.com/overview/expressions/#interpolation">interpolation</a>.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<table><thead><tr><th>Argument</th><th>Required</th><th>Description</th></tr></thead><tbody>
<tr><td><code>files</code></td><td>Yes</td><td>A list of file paths to pass to CUE</td></tr>
<tr><td><code>preHook</code></td><td>No</td><td>A shell hook to execute before CUE is invoked</td></tr>
<tr><td><code>postHook</code></td><td>No</td><td>A shell hook to execute after CUE is invoked</td></tr>
<tr><td><code>flags</code></td><td>No</td><td>Additional flags to pass to CUE</td></tr>
<tr><td><code>cue</code></td><td>No</td><td>The <code>cue</code> package to use</td></tr>
<tr><td><code>jq</code></td><td>No</td><td>The <code>jq</code> package to use</td></tr>
</tbody></table>
<p>The CUE engine builds off the concepts above. It takes a single required
argument (<code>files</code>) which is the list of files to pass to CUE. In addition to
these files, the engine will also convert the incoming configuration data into
JSON and pass it as a file to CUE. The result is that CUE will evaluate the
given <code>files</code> as well as the incoming configuration data. As noted earlier, CUE
will merge all of these together into one final output.</p>
<p>In addition to the <code>files</code> argument, pre and post-hooks can be provided that
execute before and after CUE is invoked respectively. Finally, additional flags
can be specified to further control the execution of the CUE CLI tool.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-engine"><a class="header" href="#nix-engine">Nix Engine</a></h1>
<p>The nix engine uses the set of functions provided by <code>pkgs.formats</code>. <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/pkgs-lib/formats.nix">You can
see the source here</a>.</p>
<h2 id="concepts-1"><a class="header" href="#concepts-1">Concepts</a></h2>
<p>The basic outline of an entry in <code>pkgs.formats</code> is as follows:</p>
<pre><code class="language-nix">{
    format = {}: {
        generate = name: value: pkgs.runCommand {...};
    };
}
</code></pre>
<p>Where <code>format</code> is the name of the supported format (i.e., <code>json</code>).</p>
<p>Note that the <code>format</code> entry is a function that takes a single attribute set. In
some cases, this is an empty set, but in other cases, the set contains
additional options for configuring the format.</p>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<p>When using the <code>nix</code> engine from Nixago, one can pass attributes to the set with
the following:</p>
<pre><code class="language-nix">{
    engine = nixago.lib.engines.nix { opt1 = &quot;value1&quot;; };
}
</code></pre>
<p>The provided set will be passed to the <code>format</code> argument before calling its
<code>generate</code> function.</p>
<p>When calling <code>make</code>, the specified value for the <code>format</code> attribute will be used
to determine which entry in <code>pkgs.formats</code> to invoke. Thus, specifying an
unsupported format will result in an assertion error. Refer to the <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/pkgs-lib/formats.nix">nixpkgs
source code</a> to determine the currently supported output formats.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>This chapter covers the details required to contribute to Nixago. Before
submitting a PR, please ensure you review this chapter thoroughly. Nixago has an
opinionated design and expects a specific structure to work correctly.
Understanding this structure ahead of time will make development more accessible
and increase the chance of PRs going through without issues.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design"><a class="header" href="#design">Design</a></h1>
<p>When contributing to Nixago, it's essential to understand the general design
principles that guide its development. This section provides details on how the
library is structured and introduces the basic concepts required to contribute
effectively.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<pre class="mermaid">%%{ init : { &quot;theme&quot; : &quot;dark&quot;, &quot;flowchart&quot; : { &quot;curve&quot; : &quot;linear&quot; }}}%%
%%
flowchart TD
    flake{{User's flake.nix}}
    make(Call to make)
    engine(Call to engine)
    flake -- request ---&gt; make
    make &lt;-- request ---&gt; engine
    make -- result --&gt; flake
</pre>
<p>Nixago strives to meet the Unix philosophy of &quot;do one thing and do it well.&quot; For
Nixago, this is generating and managing configuration files. Anything that falls
outside of this scope, or risks complicating internal structures, should be
moved to an external project.</p>
<p>The interface for Nixago is purposefully simple: all interactions work around
the <a href="https://github.com/nix-community/nixago/blob/master/modules/request.nix">request</a> module. This module defines all required and optional fields
necessary to generate and manage a configuration file. Extending this interface
should not be the default choice, as unmitigated changes can result in muddying
the usefulness of the interface it provides.</p>
<p>Nixago promises two outputs: a derivation for building the specified
configuration file and a shell hook that manages the file locally. Nixago hands
control over to the user regarding how the configuration should be built and how
the hook should handle it.</p>
<h2 id="engines-1"><a class="header" href="#engines-1">Engines</a></h2>
<p>There are many ways to generate a configuration file. The only restraint that
Nixago imposes is that the input data must be a valid Nix expression. The entity
that translates this Nix expression into a derivation is called an <em>engine</em>.</p>
<p>The purpose of an engine is to receive and process a request. The request's
processing depends on the engine and its underlying tools. The only expectation
that Nixago has is that a derivation is returned.</p>
<p>For example, the <code>cue</code> engine uses the <a href="https://cuelang.org/">CUE</a> CLI tool to process a list of
CUE files from the user, along with the user's input, to create a derivation
that produces the desired configuration file. This modular design allows Nixago
to be easily extended to support existing infrastructure.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
